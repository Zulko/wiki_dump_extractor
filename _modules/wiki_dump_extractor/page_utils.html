<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>wiki_dump_extractor.page_utils - wiki_dump_extractor 0.1 documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=83eaa723" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="wiki_dump_extractor.page_utils"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>wiki_dump_extractor</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ref.html">Wiki Dump Extractor Reference</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">wiki_dump_extractor</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">wiki_dump_extractor.page_utils</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for wiki_dump_extractor.page_utils</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
</span><span data-line="2">
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">regex</span>
</span><span data-line="6">
</span><span data-line="7">
<div class="viewcode-block" id="get_short_description">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.get_short_description">[docs]</a>
</span><span data-line="8"><span class="k">def</span><span class="w"> </span><span class="nf">get_short_description</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="9"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the short description of the page.&quot;&quot;&quot;</span>
</span><span data-line="10">    <span class="c1"># Look for {{short description|...}} template</span>
</span><span data-line="11">    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{short description\|(.*?)\}\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span data-line="12">    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span data-line="13">        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="14">    <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

</span><span data-line="15">
</span><span data-line="16">
<div class="viewcode-block" id="remove_appendix_sections">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.remove_appendix_sections">[docs]</a>
</span><span data-line="17"><span class="k">def</span><span class="w"> </span><span class="nf">remove_appendix_sections</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="18"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove sections like References, Notes, etc. from the text.&quot;&quot;&quot;</span>
</span><span data-line="19">    <span class="n">sections_to_remove</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="20">        <span class="s2">&quot;References&quot;</span><span class="p">,</span>
</span><span data-line="21">        <span class="s2">&quot;Notes&quot;</span><span class="p">,</span>
</span><span data-line="22">        <span class="s2">&quot;Bibliography&quot;</span><span class="p">,</span>
</span><span data-line="23">        <span class="s2">&quot;Further reading&quot;</span><span class="p">,</span>
</span><span data-line="24">        <span class="s2">&quot;External links&quot;</span><span class="p">,</span>
</span><span data-line="25">        <span class="s2">&quot;See also&quot;</span><span class="p">,</span>
</span><span data-line="26">    <span class="p">]</span>
</span><span data-line="27">    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections_to_remove</span><span class="p">:</span>
</span><span data-line="28">        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;= </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2"> =&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="29">        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="30">    <span class="k">return</span> <span class="n">text</span>
</span><span data-line="31">
</span><span data-line="32">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;== References ==.*?== Notes ==.*?&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span></div>

</span><span data-line="33">
</span><span data-line="34">
<div class="viewcode-block" id="remove_comments_and_citations">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.remove_comments_and_citations">[docs]</a>
</span><span data-line="35"><span class="k">def</span><span class="w"> </span><span class="nf">remove_comments_and_citations</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="36"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the text without comments and citations.&quot;&quot;&quot;</span>
</span><span data-line="37">    <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="38">        <span class="sa">r</span><span class="s2">&quot;&lt;!--.*?--&gt;&quot;</span><span class="p">,</span>
</span><span data-line="39">        <span class="sa">r</span><span class="s2">&quot;{{Cite.*?}}&quot;</span><span class="p">,</span>
</span><span data-line="40">        <span class="sa">r</span><span class="s2">&quot;{{cite.*?}}&quot;</span><span class="p">,</span>
</span><span data-line="41">        <span class="sa">r</span><span class="s2">&quot;{{citation.*?}}&quot;</span><span class="p">,</span>
</span><span data-line="42">        <span class="sa">r</span><span class="s2">&quot;{{sfn.*?}}&quot;</span><span class="p">,</span>
</span><span data-line="43">        <span class="sa">r</span><span class="s2">&quot;&lt;ref&gt;.*?&lt;/ref&gt;&quot;</span><span class="p">,</span>
</span><span data-line="44">        <span class="sa">r</span><span class="s2">&quot;&lt;ref.*?&gt;.*?&lt;/ref&gt;&quot;</span><span class="p">,</span>
</span><span data-line="45">        <span class="sa">r</span><span class="s2">&quot;&lt;ref.*?/&gt;&quot;</span><span class="p">,</span>
</span><span data-line="46">    <span class="p">]</span>
</span><span data-line="47">    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span><span data-line="48">        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span data-line="49">
</span><span data-line="50">    <span class="k">return</span> <span class="n">text</span></div>

</span><span data-line="51">
</span><span data-line="52">
<div class="viewcode-block" id="replace_titles_with_section_headers">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.replace_titles_with_section_headers">[docs]</a>
</span><span data-line="53"><span class="k">def</span><span class="w"> </span><span class="nf">replace_titles_with_section_headers</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span data-line="54">    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span data-line="55">        <span class="sa">r</span><span class="s2">&quot;^===\s*(.*?)\s*===&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\nSubsection: \1\n\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
</span><span data-line="56">    <span class="p">)</span>
</span><span data-line="57">    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^==\s*(.*?)\s*==&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\nSection: \1\n\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span data-line="58">    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^=\s*(.*?)\s*=&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\nChapter: \1\n\n&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span data-line="59">    <span class="k">return</span> <span class="n">text</span></div>

</span><span data-line="60">
</span><span data-line="61">
<div class="viewcode-block" id="replace_file_links_with_captions">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.replace_file_links_with_captions">[docs]</a>
</span><span data-line="62"><span class="k">def</span><span class="w"> </span><span class="nf">replace_file_links_with_captions</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span data-line="63">    <span class="k">def</span><span class="w"> </span><span class="nf">replace_file_tag</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
</span><span data-line="64">        <span class="c1"># Extract the full content between File/Image: and ]]</span>
</span><span data-line="65">        <span class="n">content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="66">        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
</span><span data-line="67">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="68">            <span class="c1"># Just [[File:filename.jpg]] — remove it</span>
</span><span data-line="69">            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="70">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="71">            <span class="c1"># [[File:filename.jpg|...|...|text of interest]]</span>
</span><span data-line="72">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">(image caption: </span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>  <span class="c1"># assume last part is the text of interest</span>
</span><span data-line="73">
</span><span data-line="74">    <span class="c1"># Match both File and Image tags</span>
</span><span data-line="75">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
</span><span data-line="76">        <span class="sa">r</span><span class="s2">&quot;\[\[(File|Image):(.*?)\]\]&quot;</span><span class="p">,</span>
</span><span data-line="77">        <span class="n">replace_file_tag</span><span class="p">,</span>
</span><span data-line="78">        <span class="n">text</span><span class="p">,</span>
</span><span data-line="79">        <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
</span><span data-line="80">    <span class="p">)</span></div>

</span><span data-line="81">
</span><span data-line="82">
<div class="viewcode-block" id="replace_nsbp_by_spaces">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.replace_nsbp_by_spaces">[docs]</a>
</span><span data-line="83"><span class="k">def</span><span class="w"> </span><span class="nf">replace_nsbp_by_spaces</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="84"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace spaces with underscores in the text.&quot;&quot;&quot;</span>
</span><span data-line="85">    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;nbsp;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{Nbsp}}&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; ; &quot;</span><span class="p">)</span></div>

</span><span data-line="86">
</span><span data-line="87">
<div class="viewcode-block" id="extract_geospatial_coordinates">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.extract_geospatial_coordinates">[docs]</a>
</span><span data-line="88"><span class="k">def</span><span class="w"> </span><span class="nf">extract_geospatial_coordinates</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span data-line="89"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return geographical coordinates (latitude, longitude) from Wikipedia page text.</span>
</span><span data-line="90">
</span><span data-line="91"><span class="sd">    Parameters</span>
</span><span data-line="92"><span class="sd">    ----------</span>
</span><span data-line="93"><span class="sd">    text : str</span>
</span><span data-line="94"><span class="sd">        The wikipedia page text to extract coordinates from.</span>
</span><span data-line="95">
</span><span data-line="96"><span class="sd">    Returns</span>
</span><span data-line="97"><span class="sd">    -------</span>
</span><span data-line="98"><span class="sd">    tuple[float, float] | None</span>
</span><span data-line="99"><span class="sd">        The geographical coordinates (latitude, longitude) or None if no coordinates are found.</span>
</span><span data-line="100"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="101">    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="102">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="103">
</span><span data-line="104">    <span class="c1"># Match {{Coord}} template variations</span>
</span><span data-line="105">    <span class="n">coord_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
</span><span data-line="106"><span class="s2">        \{\{[Cc]oord\s*\|</span>
</span><span data-line="107"><span class="s2">        (\d+)\s*\|              # Degrees latitude</span>
</span><span data-line="108"><span class="s2">        (\d+)\s*\|              # Minutes latitude</span>
</span><span data-line="109"><span class="s2">        (\d+)?\s*\|?            # Optional seconds latitude</span>
</span><span data-line="110"><span class="s2">        ([NS])\s*\|             # North/South indicator</span>
</span><span data-line="111"><span class="s2">        (\d+)\s*\|              # Degrees longitude</span>
</span><span data-line="112"><span class="s2">        (\d+)\s*\|              # Minutes longitude</span>
</span><span data-line="113"><span class="s2">        (\d+)?\s*\|?            # Optional seconds longitude</span>
</span><span data-line="114"><span class="s2">        ([EW])                  # East/West indicator</span>
</span><span data-line="115"><span class="s2">    &quot;&quot;&quot;</span>
</span><span data-line="116">    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">coord_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
</span><span data-line="117">
</span><span data-line="118">    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span data-line="119">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="120">            <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_sec</span><span class="p">,</span> <span class="n">lat_dir</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span data-line="121">            <span class="n">lon_deg</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_sec</span><span class="p">,</span> <span class="n">lon_dir</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span data-line="122">
</span><span data-line="123">            <span class="c1"># Convert to decimal degrees</span>
</span><span data-line="124">            <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat_sec</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
</span><span data-line="125">            <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_deg</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lon_sec</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
</span><span data-line="126">
</span><span data-line="127">            <span class="c1"># Apply direction</span>
</span><span data-line="128">            <span class="k">if</span> <span class="n">lat_dir</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
</span><span data-line="129">                <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="n">lat</span>
</span><span data-line="130">            <span class="k">if</span> <span class="n">lon_dir</span> <span class="o">==</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span>
</span><span data-line="131">                <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="n">lon</span>
</span><span data-line="132">
</span><span data-line="133">            <span class="k">if</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">:</span>
</span><span data-line="134">                <span class="k">return</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
</span><span data-line="135">        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="136">            <span class="k">pass</span>
</span><span data-line="137">
</span><span data-line="138">    <span class="c1"># Match coordinates in infoboxes</span>
</span><span data-line="139">    <span class="n">infobox_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
</span><span data-line="140"><span class="s2">        \|\s*(?:</span>
</span><span data-line="141"><span class="s2">            latitude\s*=\s*([+-]?\d+\.?\d*)|</span>
</span><span data-line="142"><span class="s2">            longitude\s*=\s*([+-]?\d+\.?\d*)</span>
</span><span data-line="143"><span class="s2">        )</span>
</span><span data-line="144"><span class="s2">    &quot;&quot;&quot;</span>
</span><span data-line="145">    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">infobox_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span data-line="146">    <span class="n">lat</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="147">    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span data-line="148">        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># latitude</span>
</span><span data-line="149">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="150">                <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span data-line="151">            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="152">                <span class="k">continue</span>
</span><span data-line="153">        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># longitude</span>
</span><span data-line="154">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="155">                <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span data-line="156">            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="157">                <span class="k">continue</span>
</span><span data-line="158">
</span><span data-line="159">    <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="160">        <span class="k">if</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">:</span>
</span><span data-line="161">            <span class="k">return</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
</span><span data-line="162">
</span><span data-line="163">    <span class="k">return</span> <span class="kc">None</span></div>

</span><span data-line="164">
</span><span data-line="165">
<div class="viewcode-block" id="extract_categories">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.extract_categories">[docs]</a>
</span><span data-line="166"><span class="k">def</span><span class="w"> </span><span class="nf">extract_categories</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="167"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract categories from Wikipedia text.</span>
</span><span data-line="168">
</span><span data-line="169"><span class="sd">    Parameters</span>
</span><span data-line="170"><span class="sd">    ----------</span>
</span><span data-line="171"><span class="sd">    text : str</span>
</span><span data-line="172"><span class="sd">        The Wikipedia page text to extract categories from.</span>
</span><span data-line="173">
</span><span data-line="174"><span class="sd">    Returns</span>
</span><span data-line="175"><span class="sd">    -------</span>
</span><span data-line="176"><span class="sd">    List[str]</span>
</span><span data-line="177"><span class="sd">        A list of category names with spaces normalized and sorted alphabetically.</span>
</span><span data-line="178"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="179">    <span class="c1"># Match standard category syntax, handling both [[Category:Name]] and [[Category:Name|*]] formats</span>
</span><span data-line="180">    <span class="c1"># The pipe character can be used for sorting in Wikipedia but we don&#39;t need that part</span>
</span><span data-line="181">    <span class="n">categories</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
</span><span data-line="182">        <span class="sa">r</span><span class="s2">&quot;\[\[Category:([^|\]]+)(?:\|[^\]]+)?\]\]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
</span><span data-line="183">    <span class="p">)</span>
</span><span data-line="184">
</span><span data-line="185">    <span class="c1"># Clean up category names</span>
</span><span data-line="186">    <span class="n">cleaned_categories</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="187">    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
</span><span data-line="188">        <span class="c1"># Remove HTML comments</span>
</span><span data-line="189">        <span class="n">category</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;!--.*?--&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
</span><span data-line="190">        <span class="c1"># Normalize whitespace</span>
</span><span data-line="191">        <span class="n">category</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span data-line="192">        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
</span><span data-line="193">            <span class="n">cleaned_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
</span><span data-line="194">
</span><span data-line="195">    <span class="c1"># Return unique categories sorted alphabetically</span>
</span><span data-line="196">    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cleaned_categories</span><span class="p">))</span></div>

</span><span data-line="197">
</span><span data-line="198">
<div class="viewcode-block" id="extract_infobox_category">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.extract_infobox_category">[docs]</a>
</span><span data-line="199"><span class="k">def</span><span class="w"> </span><span class="nf">extract_infobox_category</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="200"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the broad category from the infobox of a Wikipedia page.</span>
</span><span data-line="201">
</span><span data-line="202"><span class="sd">    Parameters</span>
</span><span data-line="203"><span class="sd">    ----------</span>
</span><span data-line="204"><span class="sd">    text : str</span>
</span><span data-line="205"><span class="sd">        The wikipedia page text to extract the infobox category from.</span>
</span><span data-line="206"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="207">    <span class="n">infobox_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{Infobox\s+([^\|\}]+)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span data-line="208">    <span class="k">if</span> <span class="n">infobox_match</span><span class="p">:</span>
</span><span data-line="209">        <span class="n">broad_category</span> <span class="o">=</span> <span class="n">infobox_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span data-line="210">        <span class="n">broad_category</span> <span class="o">=</span> <span class="n">broad_category</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;!--&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="211">        <span class="n">broad_category</span> <span class="o">=</span> <span class="n">broad_category</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

</span><span data-line="212">
</span><span data-line="213">
</span><span data-line="214"><span class="c1"># Compile the pattern once for better performance</span>
</span><span data-line="215"><span class="n">BRACE_PATTERN</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{(?:[^</span><span class="si">{}</span><span class="s2">]|(?R))*\}\}&quot;</span><span class="p">)</span>
</span><span data-line="216">
</span><span data-line="217">
</span><span data-line="218"><span class="k">def</span><span class="w"> </span><span class="nf">_find_matching_braces</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start_pos</span><span class="p">):</span>
</span><span data-line="219"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the position of the matching closing braces from a starting position.&quot;&quot;&quot;</span>
</span><span data-line="220">    <span class="c1"># Assume we&#39;re already inside a {{ pair, so we need to find the matching }}</span>
</span><span data-line="221">    <span class="c1"># Extract the substring starting from start_pos</span>
</span><span data-line="222">    <span class="n">substring</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:]</span>
</span><span data-line="223">
</span><span data-line="224">    <span class="c1"># Look for the pattern that matches balanced braces</span>
</span><span data-line="225">    <span class="n">match</span> <span class="o">=</span> <span class="n">BRACE_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
</span><span data-line="226">
</span><span data-line="227">    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span data-line="228">        <span class="c1"># Calculate the end position in the original string</span>
</span><span data-line="229">        <span class="c1"># Add 2 for the closing braces</span>
</span><span data-line="230">        <span class="k">return</span> <span class="n">start_pos</span> <span class="o">+</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</span><span data-line="231">
</span><span data-line="232">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span data-line="233">
</span><span data-line="234">
<div class="viewcode-block" id="parse_infobox">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.parse_infobox">[docs]</a>
</span><span data-line="235"><span class="k">def</span><span class="w"> </span><span class="nf">parse_infobox</span><span class="p">(</span><span class="n">page_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span data-line="236"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the infobox from a Wikipedia page text.</span>
</span><span data-line="237">
</span><span data-line="238"><span class="sd">    Example of infobox. This recognizes the &quot;{{Infobox&quot; pattern. then parses</span>
</span><span data-line="239"><span class="sd">    the fields starting with &quot;|&quot; as key-value pairs.</span>
</span><span data-line="240">
</span><span data-line="241"><span class="sd">    {{Infobox military conflict</span>
</span><span data-line="242"><span class="sd">    | conflict          = First Battle of the Marne</span>
</span><span data-line="243"><span class="sd">    | partof            = the [[Western Front (World War I)|Western Front]] of [[World War I]]</span>
</span><span data-line="244"><span class="sd">    | image             = German soldiers Battle of Marne WWI.jpg</span>
</span><span data-line="245"><span class="sd">    | image_size        = 300</span>
</span><span data-line="246"><span class="sd">    | caption           = German soldiers (wearing distinctive [[pickelhaube]</span>
</span><span data-line="247"><span class="sd">    | date              = 5–14 September 1914</span>
</span><span data-line="248"><span class="sd">    | place             = [[Marne River]] near [[Brasles]], east of Paris</span>
</span><span data-line="249"><span class="sd">    | coordinates       = {{coord|49|1|N|3|23|E|region:FR_type:event|display= inline}}</span>
</span><span data-line="250"><span class="sd">    | result            = Allied victory</span>
</span><span data-line="251"><span class="sd">    | territory         = German advance to Paris repulsed</span>
</span><span data-line="252"><span class="sd">    }}</span>
</span><span data-line="253">
</span><span data-line="254"><span class="sd">    Parameters</span>
</span><span data-line="255"><span class="sd">    ----------</span>
</span><span data-line="256"><span class="sd">    page_text : str</span>
</span><span data-line="257"><span class="sd">        The wikipedia page text to extract the infobox from.</span>
</span><span data-line="258">
</span><span data-line="259"><span class="sd">    Returns</span>
</span><span data-line="260"><span class="sd">    -------</span>
</span><span data-line="261"><span class="sd">    dict</span>
</span><span data-line="262"><span class="sd">        The infobox as a dictionary.</span>
</span><span data-line="263"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="264">
</span><span data-line="265">    <span class="c1"># Find the infobox pattern with proper handling of nested templates</span>
</span><span data-line="266">
</span><span data-line="267">    <span class="n">infobox_start</span> <span class="o">=</span> <span class="n">page_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;{{Infobox&quot;</span><span class="p">)</span>
</span><span data-line="268">    <span class="k">if</span> <span class="n">infobox_start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span data-line="269">        <span class="k">return</span> <span class="p">{},</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="270">
</span><span data-line="271">    <span class="n">infobox_end</span> <span class="o">=</span> <span class="n">_find_matching_braces</span><span class="p">(</span><span class="n">page_text</span><span class="p">,</span> <span class="n">infobox_start</span><span class="p">)</span>
</span><span data-line="272">    <span class="k">if</span> <span class="n">infobox_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span data-line="273">        <span class="k">return</span> <span class="p">{},</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="274">
</span><span data-line="275">    <span class="n">original_infobox_text</span> <span class="o">=</span> <span class="n">page_text</span><span class="p">[</span><span class="n">infobox_start</span><span class="p">:</span><span class="n">infobox_end</span><span class="p">]</span>
</span><span data-line="276">    <span class="n">infobox_text</span> <span class="o">=</span> <span class="n">original_infobox_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{Infobox&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="277">
</span><span data-line="278">    <span class="c1"># Extract the category (first line after &quot;{{Infobox&quot;)</span>
</span><span data-line="279">    <span class="n">category_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^\|\n]+)&quot;</span><span class="p">,</span> <span class="n">infobox_text</span><span class="p">)</span>
</span><span data-line="280">    <span class="n">category</span> <span class="o">=</span> <span class="n">category_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">category_match</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="281">    <span class="n">category</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;!--.*?--&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
</span><span data-line="282">
</span><span data-line="283">    <span class="c1"># Parse the key-value pairs</span>
</span><span data-line="284">    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">}</span>
</span><span data-line="285">
</span><span data-line="286">    <span class="c1"># Find all lines starting with &quot;|&quot;</span>
</span><span data-line="287">    <span class="n">field_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
</span><span data-line="288">        <span class="sa">r</span><span class="s2">&quot;\|\s*([a-z0-9_]+)\s*=(.*)(?=\n\||$)&quot;</span><span class="p">,</span>
</span><span data-line="289">        <span class="n">infobox_text</span><span class="p">,</span>
</span><span data-line="290">        <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">,</span>
</span><span data-line="291">    <span class="p">)</span>
</span><span data-line="292">
</span><span data-line="293">    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">field_matches</span><span class="p">:</span>
</span><span data-line="294">        <span class="n">key</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="295">        <span class="n">value</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="296">
</span><span data-line="297">        <span class="c1"># Remove HTML comments from value</span>
</span><span data-line="298">        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;!--.*?--&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="299">        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="300">
</span><span data-line="301">    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">original_infobox_text</span></div>

</span><span data-line="302">
</span><span data-line="303">
<div class="viewcode-block" id="extract_links">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.extract_links">[docs]</a>
</span><span data-line="304"><span class="k">def</span><span class="w"> </span><span class="nf">extract_links</span><span class="p">(</span><span class="n">wiki_text</span><span class="p">):</span>
</span><span data-line="305"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract all the links of the form [[true page|text]] in a dict of the form</span>
</span><span data-line="306"><span class="sd">    {text: true page}&quot;&quot;&quot;</span>
</span><span data-line="307">    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[\[([^|]+?)(?:\|(.*?))?\]\]&quot;</span>
</span><span data-line="308">    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="309">    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">wiki_text</span><span class="p">):</span>
</span><span data-line="310">        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span data-line="311">            <span class="n">text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="312">            <span class="n">page</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span data-line="313">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="314">            <span class="n">text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="315">            <span class="n">page</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span data-line="316">        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
</span><span data-line="317">            <span class="n">already_assigned</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="318">            <span class="k">if</span> <span class="n">already_assigned</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="319">                <span class="n">result</span><span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="320">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="321">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">already_assigned</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="322">                    <span class="n">result</span><span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">already_assigned</span><span class="p">]</span>
</span><span data-line="323">                <span class="k">if</span> <span class="n">page</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">text</span><span class="p">]:</span>
</span><span data-line="324">                    <span class="n">result</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span data-line="325">    <span class="k">return</span> <span class="n">result</span></div>

</span><span data-line="326">
</span><span data-line="327">
<div class="viewcode-block" id="extract_filenames">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.extract_filenames">[docs]</a>
</span><span data-line="328"><span class="k">def</span><span class="w"> </span><span class="nf">extract_filenames</span><span class="p">(</span><span class="n">wiki_text</span><span class="p">):</span>
</span><span data-line="329"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="330"><span class="sd">    Extract the filename from a MediaWiki file link using regular expressions.</span>
</span><span data-line="331">
</span><span data-line="332"><span class="sd">    Args:</span>
</span><span data-line="333"><span class="sd">        wiki_file_text (str): The MediaWiki file link text</span>
</span><span data-line="334">
</span><span data-line="335"><span class="sd">    Yields:</span>
</span><span data-line="336"><span class="sd">        str: Each extracted filename found in the text</span>
</span><span data-line="337"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="338">    <span class="c1"># Pattern to match filename in MediaWiki file syntax</span>
</span><span data-line="339">    <span class="c1"># [[File:filename.ext|...]] or [[Image:filename.ext|...]]</span>
</span><span data-line="340">    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[\[(File|Image):([^|]+?)(?:\|.*?)?\]\]&quot;</span>
</span><span data-line="341">
</span><span data-line="342">    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">wiki_text</span><span class="p">):</span>
</span><span data-line="343">        <span class="k">yield</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

</span><span data-line="344">
</span><span data-line="345">
<div class="viewcode-block" id="Section">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section">[docs]</a>
</span><span data-line="346"><span class="nd">@dataclass</span>
</span><span data-line="347"><span class="k">class</span><span class="w"> </span><span class="nc">Section</span><span class="p">:</span>
</span><span data-line="348">    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span>
</span><span data-line="349">    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="350">    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="351">    <span class="n">children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Section&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span data-line="352">    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Section&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="353">
<div class="viewcode-block" id="Section.to_dict">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.to_dict">[docs]</a>
</span><span data-line="354">    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="355"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the Section to a dictionary representation.&quot;&quot;&quot;</span>
</span><span data-line="356">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="357">            <span class="s2">&quot;section_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
</span><span data-line="358">            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span data-line="359">            <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">],</span>
</span><span data-line="360">        <span class="p">}</span></div>

</span><span data-line="361">
</span><span data-line="362">    <span class="nd">@property</span>
</span><span data-line="363">    <span class="k">def</span><span class="w"> </span><span class="nf">title_with_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="364">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="365">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">title_with_parents</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="366">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="367">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</span><span data-line="368">
<div class="viewcode-block" id="Section.with_cleaned_text">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.with_cleaned_text">[docs]</a>
</span><span data-line="369">    <span class="k">def</span><span class="w"> </span><span class="nf">with_cleaned_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="370">        <span class="n">text</span> <span class="o">=</span> <span class="n">remove_comments_and_citations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="371">        <span class="n">text</span> <span class="o">=</span> <span class="n">replace_nsbp_by_spaces</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="372">        <span class="n">text</span> <span class="o">=</span> <span class="n">replace_file_links_with_captions</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="373">        <span class="k">return</span> <span class="n">Section</span><span class="p">(</span>
</span><span data-line="374">            <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
</span><span data-line="375">            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
</span><span data-line="376">            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
</span><span data-line="377">        <span class="p">)</span></div>

</span><span data-line="378">
<div class="viewcode-block" id="Section.from_page_text">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.from_page_text">[docs]</a>
</span><span data-line="379">    <span class="nd">@classmethod</span>
</span><span data-line="380">    <span class="k">def</span><span class="w"> </span><span class="nf">from_page_text</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Section&quot;</span><span class="p">:</span>
</span><span data-line="381"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a tree of Section objects from a page text.&quot;&quot;&quot;</span>
</span><span data-line="382">        <span class="n">root_section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Root&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="383">        <span class="n">section_stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">root_section</span><span class="p">]</span>
</span><span data-line="384">
</span><span data-line="385">        <span class="c1"># Pattern to match section headers</span>
</span><span data-line="386">        <span class="n">header_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(=+)\s*(.*?)\s*\1$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span><span data-line="387">
</span><span data-line="388">        <span class="c1"># Find all section headers</span>
</span><span data-line="389">        <span class="n">header_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">header_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span><span data-line="390">
</span><span data-line="391">        <span class="c1"># If no headers found, put all text in root section</span>
</span><span data-line="392">        <span class="k">if</span> <span class="ow">not</span> <span class="n">header_matches</span><span class="p">:</span>
</span><span data-line="393">            <span class="n">root_section</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</span><span data-line="394">            <span class="k">return</span> <span class="n">root_section</span>
</span><span data-line="395">
</span><span data-line="396">        <span class="c1"># Process each section</span>
</span><span data-line="397">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header_matches</span><span class="p">):</span>
</span><span data-line="398">            <span class="c1"># Get section level and title</span>
</span><span data-line="399">            <span class="n">level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span data-line="400">            <span class="n">title</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="401">
</span><span data-line="402">            <span class="c1"># Get section text (includes the header itself)</span>
</span><span data-line="403">            <span class="n">start</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span data-line="404">            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="405">                <span class="n">header_matches</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span data-line="406">                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_matches</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="407">                <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="408">            <span class="p">)</span>
</span><span data-line="409">            <span class="n">section_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span data-line="410">
</span><span data-line="411">            <span class="c1"># Add text before the first section to root</span>
</span><span data-line="412">            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="413">                <span class="n">root_section</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span>
</span><span data-line="414">
</span><span data-line="415">            <span class="c1"># Create new section</span>
</span><span data-line="416">            <span class="n">new_section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">section_text</span><span class="p">)</span>
</span><span data-line="417">
</span><span data-line="418">            <span class="c1"># Pop sections from stack until appropriate parent is found</span>
</span><span data-line="419">            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">section_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">section_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">level</span><span class="p">:</span>
</span><span data-line="420">                <span class="n">section_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span data-line="421">
</span><span data-line="422">            <span class="c1"># Add as child to parent</span>
</span><span data-line="423">            <span class="n">parent</span> <span class="o">=</span> <span class="n">section_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="424">            <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_section</span><span class="p">)</span>
</span><span data-line="425">            <span class="n">new_section</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span data-line="426">
</span><span data-line="427">            <span class="c1"># Add to stack</span>
</span><span data-line="428">            <span class="n">section_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_section</span><span class="p">)</span>
</span><span data-line="429">
</span><span data-line="430">        <span class="k">return</span> <span class="n">root_section</span></div>

</span><span data-line="431">
<div class="viewcode-block" id="Section.from_page_section_texts">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.from_page_section_texts">[docs]</a>
</span><span data-line="432">    <span class="nd">@classmethod</span>
</span><span data-line="433">    <span class="k">def</span><span class="w"> </span><span class="nf">from_page_section_texts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Section&quot;</span><span class="p">:</span>
</span><span data-line="434"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a tree of Section objects from a list of section texts.&quot;&quot;&quot;</span>
</span><span data-line="435">        <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="436">        <span class="n">stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="437">
</span><span data-line="438">        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
</span><span data-line="439">            <span class="n">current_section</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_single_section_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="440">
</span><span data-line="441">            <span class="c1"># Pop sections from stack until the stack is empty or the top section is of a lower level.</span>
</span><span data-line="442">            <span class="k">while</span> <span class="n">stack</span> <span class="ow">and</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">current_section</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
</span><span data-line="443">                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span data-line="444">
</span><span data-line="445">            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
</span><span data-line="446">                <span class="c1"># No parent available; this is a root section.</span>
</span><span data-line="447">                <span class="n">roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>
</span><span data-line="448">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="449">                <span class="c1"># The current section is a child of the last section in the stack.</span>
</span><span data-line="450">                <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>
</span><span data-line="451">                <span class="n">current_section</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="452">
</span><span data-line="453">            <span class="c1"># Push the current section onto the stack.</span>
</span><span data-line="454">            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_section</span><span class="p">)</span>
</span><span data-line="455">
</span><span data-line="456">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="457">            <span class="k">return</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="458">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="459">            <span class="c1"># If no sections were found, return an empty list</span>
</span><span data-line="460">            <span class="k">if</span> <span class="ow">not</span> <span class="n">roots</span><span class="p">:</span>
</span><span data-line="461">                <span class="k">return</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Root&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="462">
</span><span data-line="463">            <span class="c1"># Create a root section to hold all sections if there are multiple roots</span>
</span><span data-line="464">            <span class="n">root_section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Root&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="465">            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
</span><span data-line="466">                <span class="n">root_section</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
</span><span data-line="467">                <span class="n">section</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">root_section</span>
</span><span data-line="468">            <span class="k">return</span> <span class="n">root_section</span></div>

</span><span data-line="469">
<div class="viewcode-block" id="Section.from_single_section_text">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.from_single_section_text">[docs]</a>
</span><span data-line="470">    <span class="k">def</span><span class="w"> </span><span class="nf">from_single_section_text</span><span class="p">(</span><span class="n">section_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Section&quot;</span><span class="p">:</span>
</span><span data-line="471"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="472"><span class="sd">        Parse a heading string of the form &#39;== Title ==&#39; or &#39;=== Title ===&#39;</span>
</span><span data-line="473"><span class="sd">        and return a Section with the appropriate level and title.</span>
</span><span data-line="474"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="475">        <span class="c1"># Regex: group1: leading equals signs, group2: title, then trailing equals that match group1</span>
</span><span data-line="476">        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">section_text</span><span class="p">:</span>
</span><span data-line="477">            <span class="k">return</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">section_text</span><span class="p">)</span>
</span><span data-line="478">        <span class="n">header</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">section_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="479">
</span><span data-line="480">        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(=+)\s*(.*?)\s*\1$&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
</span><span data-line="481">        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span data-line="482">            <span class="n">equals</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="483">            <span class="n">title</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="484">            <span class="n">level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equals</span><span class="p">)</span>
</span><span data-line="485">
</span><span data-line="486">            <span class="k">return</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
</span><span data-line="487">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="488">            <span class="k">return</span> <span class="n">Section</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">section_text</span><span class="p">)</span></div>

</span><span data-line="489">
<div class="viewcode-block" id="Section.get_section_text_by_title">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.get_section_text_by_title">[docs]</a>
</span><span data-line="490">    <span class="k">def</span><span class="w"> </span><span class="nf">get_section_text_by_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="491">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="n">title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">title_with_parents</span> <span class="o">==</span> <span class="n">title</span><span class="p">:</span>
</span><span data-line="492">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>
</span><span data-line="493">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="494">            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
</span><span data-line="495">                <span class="n">result</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_section_text_by_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span data-line="496">                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="497">                    <span class="k">return</span> <span class="n">result</span></div>

</span><span data-line="498">
<div class="viewcode-block" id="Section.all_subsections_text_dict">
<a class="viewcode-back" href="../../ref.html#wiki_dump_extractor.page_utils.Section.all_subsections_text_dict">[docs]</a>
</span><span data-line="499">    <span class="k">def</span><span class="w"> </span><span class="nf">all_subsections_text_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="500"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="501"><span class="sd">        Recursively collect text from a section and all its subsections.</span>
</span><span data-line="502">
</span><span data-line="503"><span class="sd">        Args:</span>
</span><span data-line="504"><span class="sd">            text_dict: Dictionary to store section titles and texts</span>
</span><span data-line="505">
</span><span data-line="506"><span class="sd">        Returns:</span>
</span><span data-line="507"><span class="sd">            Dictionary mapping section titles to their text content</span>
</span><span data-line="508"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="509">        <span class="k">if</span> <span class="n">text_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="510">            <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="511">
</span><span data-line="512">        <span class="n">text_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>
</span><span data-line="513">
</span><span data-line="514">        <span class="k">for</span> <span class="n">sub_section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
</span><span data-line="515">            <span class="n">sub_section</span><span class="o">.</span><span class="n">all_subsections_text_dict</span><span class="p">(</span><span class="n">text_dict</span><span class="p">)</span>
</span><span data-line="516">
</span><span data-line="517">        <span class="k">return</span> <span class="n">text_dict</span></div>

</span><span data-line="518">
</span><span data-line="519">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="520">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Section[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">](title=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">, text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...)&quot;</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Zulko</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=e2e99575"></script></body>
</html>